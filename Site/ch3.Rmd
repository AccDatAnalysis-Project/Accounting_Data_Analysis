# 第3章 会計情報を前処理する(応用) {-}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Dropbox/Research/AccDatAna_Project/会計情報のデータ分析/2稿_v2/ch3")
```

#### 学習目標 {-}
1. 読み込んだ会計データと他のデータとの結合・整理が実行できる
2. 財務数値を作成し，記述統計量をグループ間で比較できる
3. 2期間以上の会計情報が必要な財務数値を作成できる


#### 応用例 {-}
1. 業界間での収益性指標の比較
2. 上場年数で分けたグループ間での費用構造の比較

#### 関連する会計研究 {-}
Srivastava, A. (2014) ‘’Why have measures of earnings quality changed over time?” _Journal of Accounting and Economics_, Vol. 57, No, 2–3, pp. 196-217.


## この章について
　この章では，複数のデータセットを利用して会計データを分析する方法について学習する。2章では，会計データをcsv形式で保存し，保存したcsvファイルをread_csv()関数を利用することで，R上に会計データを読み込むことができた。しかし，実際に会計情報を分析するためには，会計データだけではなく，他のデータを利用する場面も多い。たとえば，産業データ，株価データ，マクロデータといったデータセットである。このような他のデータと会計データを組み合わせることで，会計データに産業データを結合して産業間でROEを比較する，会計データに株価データを結合して時価簿価比率を計算するといった分析ができるようになる。複数のデータセットを利用した分析をするには，(1)会計データと結合したい他のデータセットの両方を読み込んだうえで2つのデータセットを結合・整理する，(2)結合・整理したデータセットで財務数値を計算する，という2つの作業が必要になる。また，分母に期首・期末の平均資産をもちいるROAなどの財務数値を作成したければ当期の会計データに前期の会計データを結合するというパネルデータの取り扱いも必要になるだろう。この章では，(1)複数データの結合・整理，(2)財務指標の作成と要約，(3)パネルデータの取り扱い，の3つについて学習する。

　この章で学習する分析は，非常にシンプルなものであるものの，そのシンプルさ故に強力な証拠ともなり得る。たとえば，この章で学習する分析をもちいた興味深い研究として，Srivastava(2014)が挙げられる。米国企業では費用収益対応(matching)が一貫して低下しており，会計情報の有効性が低下しているのではないかという一連の議論がある。Srivastava(2014)は，販売費及び一般管理費(以下、販管費)の支出割合が高い新規企業が参入することで，米国企業における費用収益対応が低下したのではないかと主張した。会計処理上，売上原価は売上高と個別対応であるのに対して，販管費は期間対応である。そのため，新しい企業ほど総費用に占める販管費の割合が高ければ，そのような企業が新規参入することでサンプル全体の費用収益対応の程度は低下することになるだろう。この論文で行われた分析の一つが，企業を上場時期ごとにグルーピングし，グループ間で総費用に占める販管費の割合を比較するというシンプルな分析だった。分析結果は，上場年数の新しいグループは販管費の割合が高く，逆に上場年度の古いグループは売上原価の割合が高いという予想通りのものだった。Srivastava(2014)の分析結果は，そのシンプルさ故に強力な証拠となっている。Srivastava(2014)と同様の分析を行うには，会計データに上場年数のデータセットを結合し，上場年数のグループ間で総費用に占める各費用の割合を計算するという操作が必要になる。いずれも，この章で学習する操作ができれば実行できるだろう。

## 会計データとほかのデータの結合・整理
　それでは，会計データと他のデータセットを結合する方法について学習しよう。3章および4章では，ドラッグストアと家電量販店の会計数値を比較する。分析対象企業は，業界動向サーチ (https://gyokai-search.com) からドラッグストアと家電量販店の売上高ランキング上位10社(計20社)を対象とした(2019年3月6日時点)[^1]。まずは，会計データをバフェットコードよりダウンロードして，read_csv()関数で読み込む。バフェットコードからダウンロード(2019年3月6日時点)できたのは，20社中18社でありデータにいくつか欠損があった。そこで，欠損のあった企業の有価証券報告書をEDINETからダウンロードして，残りの数値を手入力したデータがch3_findata_ch3.csvである。データが完成したら，read_csv()関数で読み込もう。なお，パッケージであるtidyverseを呼び出すのを忘れないように。その後，selectで必要は列のみを取り出し，renameで名前を英語にしておこう。

```{r}
# 財務データの読み込み
  library(tidyverse)
df_0 <- read_csv("ch3_findata.csv",
  locale = locale(encoding = "cp932")
)

df_1 <- df_0 %>%
  select(
    銘柄コード,
    会社名,
    売上高,
    売上原価,
    販管費,
    総資産
  ) %>%
  rename(
    id    = 銘柄コード,
    name  = 会社名,
    sales = 売上高,
    cogs  = 売上原価,
    sga   = 販管費,
    asset = 総資産
  )
```

　次に，業種データを作成して読み込む。なお，東証業種分類など公式な分類であれば，手入力しなくとも日経NEEDSなどのデータベースからダウンロードすることが可能である。今回は，業界リサーチの家電量販店(https://gyokai-search.com/3-kaden-ryohan.htm)とドラッグストア(https://gyokai-search.com/3-drag.htm)のサイトをもとに，「銘柄コード」，「会社名」，「業界」という3つの列からなるデータセットを手入力で作成し，「ch3_inddata.csv」というファイルを作成した。この業種データをRで読み込み、会計データに結合して、会計データの各企業がどの業種に分類されているのかわかるようにしたいというのが、これからやりたいことである。データセットの結合には、結合したい列に加えて結合キーが必要になる。例えば、会計データセットにおけるカワチ薬品の行には、業種データセットにおけるカワチ薬品の行を結合したい。すなわち、3つのデータセットでどの行にどの行を紐付けるのか番号などをつけて明確にしておく必要があり、これを結合キーという。今回は銘柄コードを結合キーとして使うことにしよう。そこで、業種データからは結合したい列「業界」と、結合キーである「銘柄コード」を残すことにしよう。
　
```{r}
# 業界データの読み込み
df_ind_0 <- read_csv("ch3_inddata.csv",
  locale = locale(encoding = "cp932")
)

# 変数名の変更
df_ind_1 <- df_ind_0 %>%
  select(
    銘柄コード,
    業界
  ) %>%
  rename(
    id  = 銘柄コード,
    ind = 業界
  )
```

　それでは，2つのデータセットを結合しよう。今回は両データセットに共通する行のみを残したいので，`inner_join()`関数をつかって結合する。結合キーには「銘柄コード(id)」を使用する。なお，inner_join()関数以外にも，左側に記入するデータセットの行をすべて残すleft_join()関数，両方のデータセットの行をすべて残すfull_join()関数がある。
結合できたら、head()関数で結果を確認してみよう。また、このデータセットに，どういう業界が含まれているか確認するには、table()関数を使用する。table()関数は度数を計算するための関数で，データセットにおける業界ごとの行数を数えて出力してくれている。

```{r}
# データの結合
df_2 <- inner_join(df_1, df_ind_1,
  by = "id"
)

# 上から6行目まで確認
head(df_2)

# 業界ごとの度数の確認
df_2 %>%
  select(ind) %>%
  table()
```

　`table()` 関数の結果より，結合されたデータセットの内訳が確認できる。以下では，ド ラッグストア業界に属する企業 10 社と家電量販店業界に属する企業 8 社で財務数値を比 較していく。なお，R は日本語の取り扱いがそれほど得意ではないので，業界名を英語に 修正しておく。業界の英語名を示す「ind_eng」という新しい列をデータセットに追加す る。データセットに列を追加するには mutate() 
関数を使う。今回は，「ind」の列に記入さ れている日本語名を英語名に置き換えたいので，recode() 関数も使って下記のように記入 する。

```{r}
# 業界名を英語に変更
df_2 <- df_2 %>%
  mutate(ind_eng = recode(ind,
    "ドラッグストア" = "DrugStore",
    "家電"           = "ElectronicsRetail"
  ))

head(df_2)

```



```{r}

```

[^1]: 本来は業種の分類は東証業種分類や日経業種分類といった公式の業界分類を使うことが学術的に望ましい。しかし，本書はテキストであり，会計数値に関する議論を直感的に理解しやすいことに重点を置いたため，今回はこの分類を採用している。